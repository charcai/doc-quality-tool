<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>开源文档质量检测工具</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="app" class="container mx-auto px-4 py-10 max-w-4xl">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-blue-600 mb-2">文档和贡献指南质量检测工具</h1>
            <p class="text-gray-500">基于社区规范，自动化评估开源项目文档质量</p>
        </header>

        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <div class="flex gap-4">
                <input 
                    v-model="repoUrl" 
                    type="text" 
                    placeholder="请输入 GitHub 项目 URL (例如: https://github.com/vuejs/core)" 
                    class="flex-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    @keyup.enter="analyze"
                >
                <button 
                    @click="analyze" 
                    :disabled="loading"
                    class="bg-blue-600 text-white px-8 py-3 rounded-lg font-semibold hover:bg-blue-700 disabled:bg-gray-400 transition"
                >
                    {{ loading ? '检测中...' : '开始检测' }}
                </button>
            </div>
            <p v-if="error" class="text-red-500 mt-3 text-sm">{{ error }}</p>
        </div>

        <div v-if="result" class="grid grid-cols-1 md:grid-cols-2 gap-8 animate-fade-in">
            
            <div class="bg-white p-6 pb-10 rounded-xl shadow-lg flex flex-col items-center justify-center">
                <h3 class="text-xl font-bold mb-4 text-gray-700">五维能力图谱</h3>
                <div id="radar-chart" style="width: 100%; height: 350px;"></div>
                <div class="mt-4 text-center">
                    <span class="text-gray-500">综合评分</span>
                    <div class="text-5xl font-bold text-blue-600 mt-1">{{ result.totalScore }}</div>
                </div>
            </div>

            <div class="bg-white p-6 rounded-xl shadow-lg">
                <h3 class="text-xl font-bold mb-4 text-gray-700">诊断报告 & 改进建议</h3>
                <div class="space-y-4">
                    <div class="item" v-for="(item, key) in dimensionMap" :key="key">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-semibold text-gray-700">{{ item.label }}</span>
                            <span :class="getScoreColor(result.dimensions[key].score)">
                                {{ result.dimensions[key].score.toFixed(0) }}分
                            </span>
                        </div>
                        <div class="text-sm text-gray-500 bg-gray-50 p-2 rounded">
                            建议：{{ result.dimensions[key].details }}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, nextTick } = Vue;

        createApp({
            setup() {
                const repoUrl = ref('https://github.com/axios/axios'); // 默认值方便测试
                const loading = ref(false);
                const result = ref(null);
                const error = ref(null);
                let chartInstance = null;

                const dimensionMap = {
                    completeness: { label: '完整性 (Completeness)' },
                    normativeness: { label: '规范性 (Normativeness)' },
                    readability: { label: '可读性 (Readability)' },
                    timeliness: { label: '时效性 (Timeliness)' },
                    usability: { label: '可用性 (Usability)' }
                };

                const analyze = async () => {
                    if(!repoUrl.value) return;
                    loading.value = true;
                    error.value = null;
                    result.value = null;

                    try {
                        const res = await fetch('/api/analyze', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ url: repoUrl.value })
                        });
                        const data = await res.json();

                        if (data.success) {
                            result.value = data.data;
                            await nextTick();
                            renderChart(data.data.dimensions);
                        } else {
                            error.value = data.error || '检测失败，请检查 URL 是否正确';
                        }
                    } catch (e) {
                        error.value = '网络错误，请稍后重试';
                    } finally {
                        loading.value = false;
                    }
                };

                const renderChart = (dims) => {
                    const chartDom = document.getElementById('radar-chart');
                    if (chartInstance) chartInstance.dispose();
                    chartInstance = echarts.init(chartDom);

                    const option = {
                        radar: {
                            indicator: [
                                { name: '完整性', max: 100 },
                                { name: '规范性', max: 100 },
                                { name: '可读性', max: 100 },
                                { name: '时效性', max: 100 },
                                { name: '可用性', max: 100 }
                            ],
                            radius: '65%'
                        },
                        series: [{
                            name: '文档质量',
                            type: 'radar',
                            data: [{
                                value: [
                                    dims.completeness.score,
                                    dims.normativeness.score,
                                    dims.readability.score,
                                    dims.timeliness.score,
                                    dims.usability.score
                                ],
                                name: '当前项目',
                                areaStyle: { color: 'rgba(59, 130, 246, 0.2)' },
                                itemStyle: { color: '#2563eb' }
                            }]
                        }]
                    };
                    chartInstance.setOption(option);
                };

                const getScoreColor = (score) => {
                    if (score >= 80) return 'text-green-600 font-bold';
                    if (score >= 60) return 'text-yellow-600 font-bold';
                    return 'text-red-600 font-bold';
                };

                return {
                    repoUrl,
                    loading,
                    result,
                    error,
                    analyze,
                    dimensionMap,
                    getScoreColor
                };
            }
        }).mount('#app');
    </script>
</body>
</html>